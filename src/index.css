// @ts-nocheck
import React, { useEffect, useMemo, useState } from 'react'

/* src/index.css (dosyanın sonuna ekle) */
.safe-top { padding-top: env(safe-area-inset-top); }
.blur-surface { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }


const UNIT_TYPES = [
  { id: 'check', label: 'Checkbox' },
  { id: 'count', label: 'Adet' },
  { id: 'minutes', label: 'Dakika' },
  { id: 'ml', label: 'mL' },
  { id: 'grams', label: 'Gram' },
]

function daysInMonth(year, monthIndex) { return new Date(year, monthIndex + 1, 0).getDate() }
function todayParts() { const now = new Date(); return { y: now.getFullYear(), m: now.getMonth(), d: now.getDate() } }

const DEFAULT_HABITS = [
  { id: 'wakeBefore9',   title: "9'dan önce kalk",           unit: 'check',   target: 1 },
  { id: 'sleepBefore11', title: "11'den önce yatağa gir",    unit: 'check',   target: 1 },
  { id: 'morningStretch',title: 'Sabah egzersizi / esneme',   unit: 'minutes', target: 15 },
  { id: 'gym',           title: 'Gym',                        unit: 'minutes', target: 60 },
  { id: 'aiBuild',       title: 'AI Build Time',              unit: 'minutes', target: 60 },
  { id: 'read',          title: 'Kitap okuma',                unit: 'minutes', target: 15 },
  { id: 'plan',          title: 'Gün hedef planlama',         unit: 'minutes', target: 5 },
  { id: 'postural',      title: 'Postural egzersiz',          unit: 'minutes', target: 10 },
  { id: 'protein',       title: 'Protein',                    unit: 'grams',   target: 80 },
  { id: 'water',         title: 'Su tüketimi',                unit: 'ml',      target: 3000 },
  { id: 'social',        title: 'Sosyal zaman (isim yaz)',    unit: 'count',   target: 1 },
  { id: 'alcohol',       title: 'Alkol (kadeh)',              unit: 'count',   target: 0 },
]

const STORAGE_KEY = 'lifestyle_challenge_state_v1'

export default function App() {
  const { y: ty, m: tm, d: td } = todayParts()
  const [year, setYear] = useState(ty)
  const [month, setMonth] = useState(tm)
  const [habits, setHabits] = useState(DEFAULT_HABITS)
  const [data, setData] = useState({})
  const [title, setTitle] = useState('Lifestyle Challenge')
  const [editingHabit, setEditingHabit] = useState(null)
  const [showSettings, setShowSettings] = useState(false)

  useEffect(() => {
    try {
      const raw = localStorage.getItem(STORAGE_KEY)
      if (!raw) return
      const parsed = JSON.parse(raw)
      if (parsed.year) setYear(parsed.year)
      if (typeof parsed.month === 'number') setMonth(parsed.month)
      if (Array.isArray(parsed.habits)) setHabits(parsed.habits)
      if (parsed.data) setData(parsed.data)
      if (parsed.title) setTitle(parsed.title)
    } catch {}
  }, [])
  useEffect(() => {
    localStorage.setItem(
      STORAGE_KEY,
      JSON.stringify({ year, month, habits, data, title })
    )
  }, [year, month, habits, data, title])

  const dim = daysInMonth(year, month)

  function getCell(hid, day) { return data?.[hid]?.[day] ?? null }
  function setCell(hid, day, value) {
    setData(prev => ({ ...prev, [hid]: { ...(prev[hid] || {}), [day]: value } }))
  }

  function clearMonth() {
    if (!confirm('Bu ayın tüm işaretlemelerini silmek istiyor musun?')) return
    const cloned = { ...data }
    habits.forEach(h => {
      if (cloned[h.id]) { const c = { ...cloned[h.id] }; for (let d = 1; d <= dim; d++) delete c[d]; cloned[h.id] = c }
    })
    setData(cloned)
  }

  function exportJSON() {
    const blob = new Blob(
      [JSON.stringify({ year, month, habits, data, title }, null, 2)],
      { type: 'application/json' }
    )
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `${title.replace(/\s+/g, '_')}_${year}-${String(month + 1).padStart(2, '0')}.json`
    a.click(); URL.revokeObjectURL(url)
  }
  function importJSON(file) {
    const reader = new FileReader()
    reader.onload = () => {
      try {
        const obj = JSON.parse(String(reader.result))
        if (obj.title) setTitle(obj.title)
        if (obj.year) setYear(obj.year)
        if (typeof obj.month === 'number') setMonth(obj.month)
        if (Array.isArray(obj.habits)) setHabits(obj.habits)
        if (obj.data) setData(obj.data)
      } catch { alert('Geçersiz JSON') }
    }
    reader.readAsText(file)
  }

  function addHabit() {
    const base = { id: `habit_${Date.now()}`, title: 'Yeni hedef', unit: 'check', target: 1 }
    setHabits(h => [...h, base]); setEditingHabit(base)
  }
  function removeHabit(id) {
    if (!confirm('Bu hedefi silmek istiyor musun?')) return
    setHabits(prev => prev.filter(h => h.id !== id))
    setData(prev => { const c = { ...prev }; delete c[id]; return c })
  }

  function cycleValue(habit, current) {
    if (habit.unit === 'check') return current ? 0 : 1
    if (habit.unit === 'count') return (Number(current) || 0) + 1
    if (habit.unit === 'minutes') return (Number(current) || 0) + 5
    if (habit.unit === 'ml') return (Number(current) || 0) + 250
    if (habit.unit === 'grams') return (Number(current) || 0) + 10
    return current
  }

  function scoreFor(habit, day) {
    const v = getCell(habit.id, day)
    if (v == null) return 0
    if (habit.unit === 'check') return v ? 1 : 0
    if (['count','minutes','ml','grams'].includes(habit.unit)) return Math.min(1, Number(v) / Number(habit.target || 1))
    return 0
  }

  const dailyScores = useMemo(() => {
    const arr = []
    for (let d = 1; d <= dim; d++) {
      const s = habits.reduce((acc, h) => acc + scoreFor(h, d), 0)
      arr.push(s / Math.max(1, habits.length))
    }
    return arr
  }, [habits, data, dim])

  function longestStreak() {
    let best = 0, cur = 0
    for (let d = 1; d <= dim; d++) {
      if (dailyScores[d - 1] >= 0.8) { cur += 1; best = Math.max(best, cur) } else cur = 0
    }
    return best
  }

  function monthNameTR(idx) {
    return ['Ocak','Şubat','Mart','Nisan','Mayıs','Haziran','Temmuz','Ağustos','Eylül','Ekim','Kasım','Aralık'][idx]
  }

  return (
    <div className="min-h-dvh bg-neutral-950 text-neutral-100 p-3 sm:p-4 md:p-6">
      <div className="w-full max-w-none">
        <header className="flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
          <input
            className="bg-transparent text-2xl md:text-3xl font-semibold outline-none border-b border-neutral-700 focus:border-neutral-400 w-full md:w-auto"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
          />
          <div className="flex flex-wrap items-center gap-2">
            <select className="bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2" value={month} onChange={(e)=>setMonth(Number(e.target.value))}>
              {Array.from({ length: 12 }, (_, i) => (<option key={i} value={i}>{monthNameTR(i)}</option>))}
            </select>
            <input type="number" className="bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 w-28" value={year} onChange={(e)=>setYear(Number(e.target.value))} />
            <button onClick={()=>setShowSettings(s=>!s)} className="inline-flex items-center gap-2 bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 hover:bg-neutral-800">Ayarlar</button>
            <button onClick={exportJSON} className="inline-flex items-center gap-2 bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 hover:bg-neutral-800">Dışa aktar</button>
            <label className="inline-flex items-center gap-2 bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 hover:bg-neutral-800 cursor-pointer">
              İçe aktar
              <input type="file" accept="application/json" className="hidden" onChange={(e)=>e.target.files?.[0] && importJSON(e.target.files[0])} />
            </label>
            <button onClick={clearMonth} className="inline-flex items-center gap-2 bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 hover:bg-neutral-800">Ayı temizle</button>
          </div>
        </header>

        <section className="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3">
          <StatCard label="Gün sayısı" value={dim} />
          <StatCard label="Ay ilerleme" value={`${Math.round((dailyScores.filter(x=>x>0).length/dim)*100)}%`} />
          <StatCard label="Ortalama gün skoru" value={`${Math.round((dailyScores.reduce((a,b)=>a+b,0)/Math.max(1,dailyScores.length))*100)}%`} />
          <StatCard label="En uzun streak (≥%80)" value={longestStreak()} />
        </section>

        <div className="mt-6 w-full overflow-x-auto rounded-2xl border border-neutral-800">
          <table className="w-full md:min-w-[1100px]">
            <thead className="bg-neutral-900 sticky top-0 z-10">
              <tr>
                <th className="text-left px-3 py-2 w-[320px] sticky left-0 z-20 bg-neutral-900">Hedef</th>
                {Array.from({ length: dim }, (_, i) => (
                  <th key={i} className="text-center px-2 py-2 text-sm font-medium text-neutral-300">{i + 1}</th>
                ))}
                <th className="text-center px-2 py-2 text-sm font-medium text-neutral-300">%Tamam</th>
              </tr>
            </thead>
            <tbody>
              {habits.map((h) => (
                <tr key={h.id} className="odd:bg-neutral-950 even:bg-neutral-900/40 border-t border-neutral-900">
                  <td className="px-3 py-2 align-top sticky left-0 z-10 bg-neutral-950">
                    <div className="font-medium leading-tight">{h.title}</div>
                    <div className="text-xs text-neutral-400">Birim: {UNIT_TYPES.find(u=>u.id===h.unit)?.label} · Hedef: {h.target}</div>
                    <div className="mt-1 flex gap-2">
                      <button onClick={()=>setEditingHabit(h)} className="text-xs inline-flex items-center gap-1 px-2 py-1 rounded-lg border border-neutral-700 hover:bg-neutral-800">Düzenle</button>
                      <button onClick={()=>removeHabit(h.id)} className="text-xs inline-flex items-center gap-1 px-2 py-1 rounded-lg border border-red-700/70 text-red-300 hover:bg-red-900/20">Sil</button>
                    </div>
                  </td>
                  {Array.from({ length: dim }, (_, i) => {
                    const day = i + 1
                    const val = getCell(h.id, day)
                    const score = scoreFor(h, day)
                    const isToday = year === ty && month === tm && day === td
                    return (
                      <td key={day} className="px-1 py-1 text-center align-middle">
                        <button
                          onClick={() => setCell(h.id, day, cycleValue(h, val))}
                          onContextMenu={(e) => { e.preventDefault(); setCell(h.id, day, null) }}
                          className={`w-9 h-8 sm:w-10 sm:h-8 rounded-lg border text-sm select-none ${
                            score >= 1 ? 'bg-green-600/30 border-green-600/60' : score > 0 ? 'bg-amber-600/20 border-amber-600/50' : 'bg-neutral-900 border-neutral-800'
                          } ${isToday ? 'ring-2 ring-blue-500' : ''}`}
                          title="Sol tık: artır / sağ tık: temizle"
                        >
                          {h.unit === 'check' ? (val ? '✓' : '') : (val ?? '')}
                        </button>
                      </td>
                    )
                  })}
                  <td className="px-2 py-1 text-center text-sm">
                    {(() => {
                      let s = 0; for (let d = 1; d <= dim; d++) s += scoreFor(h, d)
                      const pct = Math.round((s / dim) * 100)
                      return <span className={pct>=80?'text-green-400':'text-neutral-300'}>{pct}%</span>
                    })()}
                  </td>
                </tr>
              ))}
              <tr>
                <td className="px-3 py-3" colSpan={dim + 2}>
                  <button onClick={addHabit} className="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-blue-600/20 border border-blue-500/40 hover:bg-blue-600/30">
                    + Yeni hedef ekle
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div className="mt-6 text-sm text-neutral-400">İpucu: Hücreye tıklayınca değer artar, sağ tıkla temizlenir. %80 ve üzeri günler streak sayılır.</div>

        {editingHabit && (
          <HabitEditor
            habit={editingHabit}
            onClose={() => setEditingHabit(null)}
            onSave={(updated) => { setHabits(prev => prev.map(h => (h.id === updated.id ? updated : h))); setEditingHabit(null) }}
          />
        )}

        {showSettings && <SettingsPanel onClose={() => setShowSettings(false)} />}
      </div>
    </div>
  )
}

function StatCard({ label, value }) {
  return (
    <div className="rounded-2xl bg-neutral-900 border border-neutral-800 p-4">
      <div className="text-neutral-400 text-sm">{label}</div>
      <div className="text-2xl font-semibold mt-1">{value}</div>
    </div>
  )
}

function HabitEditor({ habit, onClose, onSave }) {
  const [title, setTitle] = useState(habit.title)
  const [unit, setUnit] = useState(habit.unit)
  const [target, setTarget] = useState(habit.target)

  return (
    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
      <div className="w-full max-w-lg rounded-2xl bg-neutral-950 border border-neutral-800 p-4">
        <div className="flex items-center justify-between mb-3">
          <div className="text-lg font-semibold">Hedefi Düzenle</div>
          <button onClick={onClose} className="text-neutral-400 hover:text-neutral-200">Kapat</button>
        </div>
        <div className="grid gap-3">
          <label className="grid gap-1">
            <span className="text-sm text-neutral-300">Başlık</span>
            <input value={title} onChange={(e)=>setTitle(e.target.value)} className="bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2"/>
          </label>
          <label className="grid gap-1">
            <span className="text-sm text-neutral-300">Birim</span>
            <select value={unit} onChange={(e)=>setUnit(e.target.value)} className="bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2">
              {UNIT_TYPES.map(u => <option key={u.id} value={u.id}>{u.label}</option>)}
            </select>
          </label>
          <label className="grid gap-1">
            <span className="text-sm text-neutral-300">Günlük Hedef</span>
            <input type="number" value={target} onChange={(e)=>setTarget(Number(e.target.value))} className="bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2"/>
          </label>
          <div className="flex justify-end gap-2 mt-2">
            <button onClick={onClose} className="px-3 py-2 rounded-xl border border-neutral-700 hover:bg-neutral-800">Vazgeç</button>
            <button onClick={()=>onSave({ ...habit, title, unit, target })} className="px-3 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-500">Kaydet</button>
          </div>
        </div>
      </div>
    </div>
  )
}

function SettingsPanel({ onClose }) {
  return (
    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
      <div className="w-full max-w-2xl rounded-2xl bg-neutral-950 border border-neutral-800 p-4">
        <div className="flex items-center justify-between mb-3">
          <div className="text-lg font-semibold">Ayarlar</div>
          <button onClick={onClose} className="text-neutral-400 hover:text-neutral-200">Kapat</button>
        </div>
        <div className="space-y-2 text-sm text-neutral-300">
          <p>• Veriler tarayıcıda <b>localStorage</b>'da saklanır. JSON dışa aktarım ile yedek alabilirsin.</p>
          <p>• Hücreye <b>sol tık</b> → artır; <b>sağ tık</b> → temizle.</p>
          <p>• Streak: Gün ortalaması ≥%80 olduğunda ardışık gün sayısı artar.</p>
        </div>
      </div>
    </div>
  )
}
